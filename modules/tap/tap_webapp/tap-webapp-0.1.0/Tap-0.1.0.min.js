/*
 * TAP - v0.1.0 - 2012-07-23
 * http://tapintomuseums.org/
 * Copyright (c) 2011-2012 Indianapolis Museum of Art
 * GPLv3
 */
function loadXMLDoc(a){return xhttp=new XMLHttpRequest,xhttp.open("GET",a,!1),xhttp.send(),xhttp.responseXML}function objectToArray(a){if(a===undefined)return;return Object.prototype.toString.call(a)!=="[object Array]"?[a]:a}function xmlToJson(a,b){var c=!0,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++)a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1&&b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}var e=!0;if(a.attributes&&a.attributes.length>0){var f;e={};for(var g=0;g<a.attributes.length;g++)f=a.attributes.item(g),e[f.nodeName.replaceArray(b,"").toCamel()]=f.nodeValue}if(a.hasChildNodes()){var h,i,j;e===!0&&(e={});for(var k=0;k<a.childNodes.length;k++){j=a.childNodes.item(k);if((j.nodeType&7)===1)h=j.nodeName.replaceArray(b,"").toCamel(),i=xmlToJson(j,b),e.hasOwnProperty(h)?(e[h].constructor!==Array&&(e[h]=[e[h]]),e[h].push(i)):e[h]=i;else if((j.nodeType-1|1)===3){h="value",i=j.nodeType===3?j.nodeValue.replace(/^\s+|\s+$/g,""):j.nodeValue;if(e.hasOwnProperty(h))e[h]+=i;else if(j.nodeType===4||i!=="")e[h]=i}}}return e}String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Asset=Backbone.Model.extend({parse:function(a){return a.propertySet=new TapAPI.collections.PropertySet(a.propertySet,a.id),a.source&&(a.source=new TapAPI.collections.Sources(a.source,a.id)),a.content&&(a.content=new TapAPI.collections.Content(a.content,a.id)),a},getSourcesByPart:function(a){if(_.isUndefined(this.get("source")))return undefined;var b,c;return b=this.get("source").where({part:a,lang:tap.language}),b.length===0&&(b=this.get("source").where({part:a})),b.length&&(c=b),c},getContentsByPart:function(a){if(_.isUndefined(this.get("content")))return undefined;var b,c;return b=this.get("content").where({part:a,lang:tap.language}),b.length===0&&(b=this.get("content").where({part:a})),b.length&&(c=b),c},getSourcesByFormat:function(a){if(_.isUndefined(this.get("source")))return undefined;var b,c;return b=this.get("source").where({format:a,lang:tap.language}),b.length===0&&(b=this.get("source").where({format:a})),b.length&&(c=b),c},getContentsByFormat:function(a){if(_.isUndefined(this.get("content")))return undefined;var b,c;return b=this.get("content").where({format:a,lang:tap.language}),b.length===0&&(b=this.get("content").where({format:a})),b.length&&(c=b),c}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Content=Backbone.Model.extend({initialize:function(){this.set("propertySet",new TapAPI.collections.PropertySet(this.get("propertySet"),this.id)),this.get("data").value&&this.set("data",this.get("data").value)},defaults:{lang:undefined,propertySet:undefined,data:undefined,format:undefined,lastModified:undefined,part:undefined}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Property=Backbone.Model.extend({defaults:{name:undefined,value:undefined,lang:undefined}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Source=Backbone.Model.extend({initialize:function(){this.set("propertySet",new TapAPI.collections.PropertySet(this.get("propertySet"),this.id))},defaults:{lang:undefined,propertySet:undefined,uri:undefined,format:undefined,lastModified:undefined,part:undefined}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Stop=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"description":case"title":if(this.attributes[a].length===0)return undefined;var b,c;return c=_.find(this.attributes[a],function(a){return a.lang===tap.language}),!c&&tap.language!==tap.defaultLanguage&&(c=_.find(this.attributes[a],function(a){return a.lang===tap.defaultLanguage})),c||(c=_.find(this.attributes[a],function(a){return a.lang===undefined||a.lang===""})),c&&(b=c.value),b;default:return this.attributes[a]}},parse:function(a){return a.propertySet=new TapAPI.collections.PropertySet(a.propertySet,a.id),a},getAssets:function(){if(_.isUndefined(this.get("assetRef")))return undefined;var a=[];return _.each(this.get("assetRef"),function(b){a.push(tap.tourAssets.get(b.id))}),_.isEmpty(a)?undefined:a},getAssetsByUsage:function(a){if(_.isUndefined(this.get("assetRef")))return undefined;var b=[];return _.each(this.get("assetRef"),function(c){c.usage===a&&b.push(tap.tourAssets.get(c.id))}),_.isEmpty(b)?undefined:b},getAssetsByType:function(a){if(_.isUndefined(this.get("assetRef")))return undefined;_.isArray(a)||(a=[a]);var b=[];return _.each(this.get("assetRef"),function(c){var d=tap.tourAssets.get(c.id);_.indexOf(a,d.get("type"))>-1&&b.push(d)}),_.isEmpty(b)?undefined:b},getSortedConnections:function(){return _.isUndefined(this.get("connections"))?undefined:_.sortBy(this.get("connection"),function(a){return parseInt(a.priority,10)})}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Tour=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"description":case"title":if(this.attributes[a].length===0)return undefined;var b,c;return c=_.find(this.attributes[a],function(a){return a.lang===tap.language}),!c&&tap.language!==tap.defaultLanguage&&(c=_.find(this.attributes[a],function(a){return a.lang===tap.defaultLanguage})),c||(c=_.find(this.attributes[a],function(a){return a.lang===undefined||a.lang===""})),c&&(b=c.value),b;default:return this.attributes[a]}},parse:function(a){return a.propertySet=new TapAPI.collections.PropertySet(a.propertySet,this.id),a}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Assets=Backbone.Collection.extend({model:TapAPI.models.Asset,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-asset")}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Content=Backbone.Collection.extend({model:TapAPI.models.Content,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-source")}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.PropertySet=Backbone.Collection.extend({model:TapAPI.models.Property,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-propertyset")},getValueByName:function(a){var b,c;return b=this.where({name:a,lang:tap.language}),b.length===0&&(b=this.where({name:a})),b.length&&(c=b[0].get("value")),c}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Sources=Backbone.Collection.extend({model:TapAPI.models.Source,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-source")}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Stops=Backbone.Collection.extend({model:TapAPI.models.Stop,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-stop")},getStopByKeycode:function(a){for(var b=0;b<this.models.length;b++){var c=this.models[b].get("propertySet").where({name:"code",value:a});if(c.length)return this.models[b]}return undefined}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Tours=Backbone.Collection.extend({model:TapAPI.models.Tour,localStorage:new Backbone.LocalStorage("tours"),selectTour:function(a){tap.currentTour=a,tap.tours.get(a).get("rootStopRef")&&(tap.currentStop=tap.tours.get(a).get("rootStopRef").id),tap.tourStops=new TapAPI.collections.Stops(null,a),tap.tourAssets=new TapAPI.collections.Assets(null,a),tap.tourAssets.fetch(),tap.tourStops.fetch(),tap.trigger("tap.tour.selected")}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Page=Backbone.View.extend({initialize:function(a){var b=null;tap.config.navbar_items!==undefined?b=tap.config.navbar_items:b=[{label:"Menu",prefix:"tourstoplist"},{label:"Keypad",prefix:"tourkeypad"},{label:"Map",prefix:"tourmap"}],_.defaults(this.options,{page_title:"",back_label:"Back",nav_menu:b,active_index:null,header_nav:!0}),this.onInit&&this.onInit()},close:function(){this.$el.empty().undelegate(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},render:function(a){return this.$el.empty(),this.$el.html(TapAPI.templateManager.get("page")({title:this.options.page_title,back_label:this.options.back_label,header_nav:this.options.header_nav,nav_menu:this.options.nav_menu,active_index:this.options.active_index,tour_id:tap.currentTour})),this.renderContent(),this},renderContent:function(){console.log("Warning: abstract TapApi.views.Page::renderContent")}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_audio_stop="AudioStop",TapAPI.views.registry.AudioStop="AudioStop",jQuery(function(){TapAPI.views.AudioStop=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("audio-stop"),b=this.$el.find(":jqmData(role='content')");b.append(a({tourStopTitle:this.model.get("title")}));var c=this.model.getAssetsByType(["tour_audio","tour_video"]);if(c){var d=this.$el.find("#audio-player"),e=this.$el.find("#video-player"),f;_.each(c,function(a){var b=a.get("source");b.each(function(a){var b="<source src='"+a.get("uri")+"' type='"+a.get("format")+"' />";switch(a.get("format").substring(0,5)){case"audio":d.append(b);break;case"video":e.append(b);break;default:console.log("Unsupported format for audio asset:",assetSource)}})});var g={},h=null;e.find("source").length&&!d.find("source").length?(d.remove(),e.show(),g.defaultVideoWidth="100%",h=e):(e.remove(),g.defaultAudioWidth="100%",h=d),h.mediaelementplayer(g)}return this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Stop=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("stop");return this.$el.find(":jqmData(role='content')").append(a({tourStopTitle:this.model.get("title")?this.model.get("title"):undefined,tourStopDescription:this.model.get("description")?this.model.get("description"):undefined})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_image_stop="ImageStop",TapAPI.views.registry.ImageStop="ImageStop",jQuery(function(){TapAPI.views.ImageStop=TapAPI.views.Page.extend({renderContent:function(){var a=tap.currentStop.get("assetRef"),b=TapAPI.templateManager.get("image-stop"),c=TapAPI.templateManager.get("image-stop-item");if(a){this.$el.find(":jqmData(role='content')").append(b());var d=this.$el.find("#gallery");$.each(a,function(a){var b=tap.tourAssets.get(this.id);if(this.usage==="image_asset"){var e={},f=b.get("source");f.each(function(a){switch(a.get("format").substring(0,5)){case"image":e.fullImageUri=a.get("uri"),e.thumbUri=a.get("uri");break;case"thumbnail":e.thumbUri=a.get("uri")}});var g=b.get("content");g.each(function(a){console.log(a);switch(a.get("part")){case"title":e.title=a.get("data");break;case"caption":e.caption=a.get("caption")}}),d.append(c(e))}});var e=d.photoSwipe({enableMouseWheel:!1,enableKeyboard:!0,doubleTapZoomLevel:0,captionAndToolbarOpacity:.8,minUserZoom:0,preventSlideshow:!0,jQueryMobile:!0})}return this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Keypad=TapAPI.views.Page.extend({events:{"tap #gobtn":"submit","tap #keypad div .button":"writekeycode","tap #delete":"clearkeycode"},onInit:function(){this.options.active_index="tourkeypad"},renderContent:function(){var a=TapAPI.templateManager.get("keypad");$(":jqmData(role='content')",this.$el).append(a())},submit:function(){if(!$("#write").html())return;if(!tap.tourStops.getStopByKeycode($("#write").html())){tap.router.showDialog("error","This is an invalid code. Please enter another."),$("#write").html("");return}$destUrl="#tourstop/"+tap.currentTour+"/code/"+$("#write").html(),Backbone.history.navigate($destUrl,!0)},writekeycode:function(a){$("#write").html($("#write").html()+$(a.currentTarget).html())},clearkeycode:function(a){$("#write").html("")},close:function(){}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Map=TapAPI.views.Page.extend({onInit:function(){console.log("MapView.initialize"),this.options.active_index="tourmap",this.tile_layer=new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',maxZoom:18}),this.map=null,this.stop_markers={},this.stop_popups={},this.position_marker=null,this.view_initialized=!1,this.LocationIcon=L.Icon.extend({iconUrl:tap.base_path+"images/icon-locate.png",shadowUrl:null,iconSize:new L.Point(24,24),iconAnchor:new L.Point(12,12)}),this.MarkerIcon=L.Icon.extend({iconUrl:tap.base_path+"images/marker.png",shadowUrl:tap.base_path+"images/marker-shadow.png",iconSize:new L.Point(25,41),iconAnchor:new L.Point(12,41)}),this.marker_icon=new this.MarkerIcon,_.defaults(this.options,{"init-lat":39.829104,"init-lon":-86.189504,"init-zoom":2})},renderContent:function(){TapAPI.geoLocation.startLocating();var a=TapAPI.templateManager.get("tour-map");$(":jqmData(role='content')",this.$el).addClass("map-content").append(a()),$(":jqmData(role='page')").live("pageshow",{map_view:this},function(a){a.data.map_view.resizeContentArea(),a.data.map_view.map===null&&a.data.map_view.initMap(),setTimeout(a.data.map_view.resizeContentArea,2e3)}),$(window).bind("orientationchange resize",this.resizeContentArea)},initMap:function(){this.map=new L.Map("tour-map"),this.map.addLayer(this.tile_layer),TapAPI.geoLocation!==null&&TapAPI.geoLocation.latest_location!==null&&(this.options["init-lat"]=TapAPI.geoLocation.latest_location.coords.latitude,this.options["init-lon"]=TapAPI.geoLocation.latest_location.coords.longitude,this.position_marker===null&&(this.position_marker=new L.Marker(new L.LatLng(this.options["init-lat"],this.options["init-lon"]),{icon:new this.LocationIcon}),this.map.addLayer(this.position_marker))),this.map.setView(new L.LatLng(this.options["init-lat"],this.options["init-lon"]),this.options["init-zoom"]);for(var a=0;a<this.options.stops.size();a++)var b=this.options.stops.at(a),c=b.get("assetRef"),d=_.each(c,this.plotTourStopMarker,{stop:b,map_view:this});return TapAPI.geoLocation.on("gotlocation",this.onLocationFound,this),this},plotTourStopMarker:function(a){if(a===undefined||a.usage!="geo")return;asset=tap.tourAssets.get(a.id);var b=asset.get("content");if(b===undefined)return;var c=$.parseJSON(b.at(0).get("data"));if(c.type=="Point"){var d=new L.LatLng(c.coordinates[1],c.coordinates[0]),e=new L.Marker(d,{icon:this.map_view.marker_icon}),f=TapAPI.templateManager.get("tour-map-marker-bubble"),g=new L.Popup;g.setLatLng(d);var h="";this.stop.get("distance")&&(h="Distance: "+this.map_view.formatStopDistance(this.stop.get("distance"))),g.setContent(f({title:this.stop.get("title"),tour_id:tap.currentTour,stop_id:this.stop.id,distance:h})),this.map_view.stop_popups[this.stop.id]=g,e.stop_id=this.stop.id,e.addEventListener("click",this.map_view.onMarkerSelected,this.map_view),this.map_view.stop_markers[this.stop.id]=e,this.map_view.map.addLayer(e)}this.stop.on("change:distance",function(a){var b="";a.get("distance")&&(b="Distance: "+this.formatStopDistance(a.get("distance"))),this.stop_popups[a.id].setContent(f({title:a.get("title"),tour_id:tap.currentTour,stop_id:a.get("id"),distance:b}))},this.map_view)},onMarkerSelected:function(a){this.map.openPopup(this.stop_popups[a.target.stop_id])},onLocationFound:function(a){var b=new L.LatLng(a.coords.latitude,a.coords.longitude);this.position_marker===null?(this.position_marker=new L.Marker(b,{icon:new this.LocationIcon}),this.map.addLayer(this.position_marker)):this.position_marker.setLatLng(b)},onLocationError:function(a){console.log("onLocationError",a)},formatStopDistance:function(a){if(tap.config.units=="si")return a<100?parseInt(a)+" m":a<1e4?(a/1e3).toFixed(2)+" km":parseInt(a/1e3)+" km";var b=3.28084*a;return b>52800?parseInt(b/5280)+" mi":b>528?(b/5280).toFixed(2)+" mi":parseInt(b)+" ft"},resizeContentArea:function(){var a,b,c,d,e;window.scroll(0,0);var f=$(":jqmData(role='page')");d=f.find(":jqmData(role='header'):visible"),c=f.find(":jqmData(role='footer'):visible"),a=f.find(":jqmData(role='content'):visible"),e=$(window).height(),b=e-d.outerHeight()-c.outerHeight(),f.find(":jqmData(role='content')").first().height(b)},onClose:function(){TapAPI.geoLocation.stopLocating(),$(window).unbind("orientationchange resize",this.resizeContentArea)}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_stop_group="StopGroup",TapAPI.views.registry.StopGroup="StopGroup",jQuery(function(){TapAPI.views.StopGroup=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("stop-group"),b={tourStopTitle:this.model.get("title")},c=this.model.get("description");c!==undefined?b.description=c:b.description="",this.$el.find(":jqmData(role='content')").append(a(b));var d=this.model.get("connection"),e=this.$el.find("#stop-list");_.each(d,function(a){var b=tap.tourStops.get(a.destId);if(b){var c=new TapAPI.views.StopGroupListItem({model:b});e.append(c.render().$el)}})}}),TapAPI.views.StopGroupListItem=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("stop-group-list-item"),render:function(){return this.$el.html(this.template({title:this.model.get("title")?this.model.get("title"):undefined,id:this.model.get("id"),tourId:tap.currentTour})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.StopList=TapAPI.views.Page.extend({onInit:function(){this.options.active_index="tourstoplist"},renderContent:function(){var a=TapAPI.templateManager.get("tour-stop-list");this.$el.find(":jqmData(role='content')").append(a());var b=this.$el.find("#tour-stop-list");_.each(tap.tourStops.models,function(a){if(tap.config.StopListView.codes_only){var c=a.get("propertySet").where({name:"code"});if(!c.length)return}var d=new TapAPI.views.StopListItem({model:a});b.append(d.render().el)},this)}}),TapAPI.views.StopListItem=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("tour-stop-list-item"),render:function(){return $(this.el).html(this.template({title:this.model.get("title")?this.model.get("title"):undefined,stop_id:this.model.get("id"),tour_id:tap.currentTour})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.TourDetails=TapAPI.views.Page.extend({onInit:function(){this.options.page_title=this.model.get("title"),this.options.header_nav=!1},renderContent:function(){var a=TapAPI.templateManager.get("tour-details");this.$el.find(":jqmData(role='content')").append(a({tour_index:tap.config.default_index,tour_id:this.model.id,publishDate:this.model.get("publishDate")?this.model.get("publishDate"):undefined,description:this.model.get("description")?this.model.get("description"):undefined,stopCount:tap.tourStops.length,assetCount:tap.tourAssets.length}))}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.TourList=TapAPI.views.Page.extend({onInit:function(){this.options.page_title="Tour List",this.options.header_nav=!1},renderContent:function(){var a=TapAPI.templateManager.get("tour-list");this.$el.find(":jqmData(role='content')").append(a);var b=this.$el.find("#tour-list");_.each(this.model.models,function(a){b.append((new TapAPI.views.TourListItem({model:a})).render().el)},this),$("#tour-list").listview("refresh")}}),TapAPI.views.TourListItem=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("tour-list-item"),render:function(){return this.$el.html(this.template({title:this.model.get("title")?this.model.get("title"):undefined,id:this.model.get("id")})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_video_stop="VideoStop",TapAPI.views.registry.VideoStop="VideoStop",jQuery(function(){TapAPI.views.VideoStop=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("video-stop");this.$el.find(":jqmData(role='content')").append(a({tourStopTitle:this.model.get("title")}));var b=this.model.getAssetsByType("tour_video");if(b.length){var c=this.$el.find("video");_.each(b,function(a){var b=a.get("source");b.each(function(a){c.append("<source src='"+a.get("uri")+"' type='"+a.get("format")+"' />")})})}return this}})}),jQuery(function(){AppRouter=Backbone.Router.extend({views:{},routes:{"":"list","tour/:tour_id":"tourDetails","tourkeypad/:tour_id":"tourKeypad","tourstop/:tour_id/:stop_id":"tourStopById","tourstop/:tour_id/code/:stop_code":"tourStopByCode","tourmap/:tour_id":"tourMap","tourstoplist/:tour_id":"tourStopList"},bookmarkMode:!1,initialize:function(){$("#back-button").live("click",function(a){return a.preventDefault(),window.history.back(),!1}),this.firstPage=!0},list:function(){this.changePage(new TapAPI.views.TourList({model:tap.tours}))},tourDetails:function(a){tap.tours.selectTour(a),this.changePage(new TapAPI.views.TourDetails({model:tap.tours.get(tap.currentTour)}))},tourKeypad:function(a){tap.tours.selectTour(a),this.changePage(new TapAPI.views.Keypad({model:tap.tours.get(tap.currentTour),page_title:"Enter a code"}))},tourStop:function(){var a=TapAPI.views.registry[tap.currentStop.get("view")];a===undefined&&(console.log("View not in registry: ",tap.currentStop.get("view")),a="Stop"),this.changePage(new TapAPI.views[a]({model:tap.currentStop,page_title:tap.tours.get(tap.currentTour).get("title")[0].value}))},tourStopById:function(a,b){tap.tours.selectTour(a),tap.currentStop=tap.tourStops.get(b),this.tourStop()},tourStopByCode:function(a,b){tap.tours.selectTour(a),tap.currentStop=tap.tourStops.getStopByKeycode(b),this.tourStop()},tourStopList:function(a){tap.tours.selectTour(a),this.changePage(new TapAPI.views.StopList({model:tap.tours.get(tap.currentTour)}))},tourMap:function(a){tap.tours.selectTour(a);var b={stops:tap.tourStops},c=tap.tours.get(tap.currentTour);_.each(c.get("appResource"),function(a){if(a===undefined||a.usage!="geo")return;asset=tap.tourAssets.get(a.id);var c=asset.get("content");if(c===undefined)return;var d=$.parseJSON(c.at(0).get("data"));d.type=="Point"&&(b["init-lon"]=d.coordinates[0],b["init-lat"]=d.coordinates[1])}),_.each(c.get("propertySet").models,function(a){a.get("name")=="initial_map_zoom"&&(b["init-zoom"]=a.get("value"))}),this.changePage(new TapAPI.views.Map(b))},changePage:function(a){tap.currentView!==undefined&&tap.currentView.close(),tap.currentView=a,$(a.el).attr("data-role","page"),a.render(),$("body").append($(a.el));var b=$.mobile.defaultPageTransition;this.firstPage&&(b="none",this.firstPage=!1),$.mobile.changePage($(a.el),{changeHash:!1,transition:b})},showDialog:function(a,b){var c=TapAPI.templateManager.get("dialog")({id:a,content:b});$("body").append(c),$.mobile.changePage("#"+a,{changeHash:!1,transition:"pop"})}})});if(!tap){var tap={};tap.tours={},tap.tourAssets={},tap.tourStops={},tap.language="en",tap.defaultLanguage="en",tap.currentStop="",tap.currentTour="";var userLang=navigator.language?navigator.language:navigator.userLanguage;tap.language=userLang.split("-")[0];var script_src=$("head script").last().attr("src");script_src.indexOf("Init.js")>=0?tap.base_path="":(tap.base_path=script_src.substring(0,script_src.lastIndexOf("/"))+"/",console.log("TAP.js base path: "+tap.base_path)),_.extend(tap,Backbone.Events),tap.initApp=function(a,b){tap.url=a,b===undefined&&(b={}),tap.config=_.defaults(b,{navbar_items:[{label:"Menu",prefix:"tourstoplist"},{label:"Keypad",prefix:"tourkeypad"},{label:"Map",prefix:"tourmap"}],default_index:"tourstoplist",units:"si",StopListView:{codes_only:!0}}),TapAPI.geoLocation!==undefined&&tap.on("tap.tour.selected",TapAPI.geoLocation.parseCurrentStopLocations),tap.trigger("tap.init.start"),tap.tours=new TapAPI.collections.Tours,tap.tours.fetch();var c=xmlToJson(loadXMLDoc(tap.url)),d,e;if(c.tour)tap.initModels(c.tour);else if(c.tourSet&&c.tourSet.tourRef){e=c.tourSet.tourRef.length;for(d=0;d<e;d++){var f=xmlToJson(loadXMLDoc(c.tourSet.tourRef[d].uri));tap.initModels(f.tour)}}else if(c.tourSet&&c.tourSet.tour){e=c.tourSet.tour.length;for(d=0;d<e;d++)tap.initModels(c.tourSet.tour[d])}tap.trigger("tap.init.end"),tap.router=new AppRouter},tap.initModels=function(a){var b=tap.tours.get(a.id);if(b&&Date.parse(a.lastModified)<=Date.parse(b.get("lastModified")))return;var c=new TapAPI.collections.Stops(null,a.id),d=new TapAPI.collections.Assets(null,a.id);tap.tours.get(a.id)&&(tap.tours.get(a.id).destroy(),c.fetch(),c.each(function(a){a.destroy()}),d.fetch(),d.each(function(a){a.destroy()})),tap.trigger("tap.init.create-tour",{id:a.id}),tap.tours.create({id:a.id,appResource:a.tourMetadata&&a.tourMetadata.appResource?objectToArray(a.tourMetadata.appResource):undefined,connection:objectToArray(a.connection),description:a.tourMetadata&&a.tourMetadata.description?objectToArray(a.tourMetadata.description):undefined,lastModified:a.tourMetadata&&a.tourMetadata.lastModified?a.tourMetadata.lastModified:undefined,propertySet:a.tourMetadata&&a.tourMetadata.propertySet?objectToArray(a.tourMetadata.propertySet.property):undefined,publishDate:a.tourMetadata&&a.tourMetadata.publishDate?objectToArray(a.tourMetadata.publishDate):undefined,rootStopRef:a.tourMetadata&&a.tourMetadata.rootStopRef?a.tourMetadata.rootStopRef:undefined,title:a.tourMetadata&&a.tourMetadata.title?objectToArray(a.tourMetadata.title):undefined});var e,f,g=a.stop.length;for(e=0;e<g;e++){var h=[];if(!_.isUndefined(a.connection))for(f=0;f<a.connection.length;f++)a.connection[f].srcId==a.stop[e].id&&h.push({priority:a.connection[f].priority,destId:a.connection[f].destId});c.create({id:a.stop[e].id,connection:h,view:a.stop[e].view,description:objectToArray(a.stop[e].description),propertySet:a.stop[e].propertySet?objectToArray(a.stop[e].propertySet.property):undefined,assetRef:objectToArray(a.stop[e].assetRef),title:objectToArray(a.stop[e].title)})}var i=a.asset.length;for(e=0;e<i;e++){if(a.asset[e].source){a.asset[e].source=objectToArray(a.asset[e].source);var j=a.asset[e].source.length;for(f=0;f<j;f++)a.asset[e].source[f].propertySet&&(a.asset[e].source[f].propertySet=objectToArray(a.asset[e].source[f].propertySet.property))}if(a.asset[e].content){a.asset[e].content=objectToArray(a.asset[e].content);var k=a.asset[e].content.length;for(f=0;f<k;f++)a.asset[e].content[f].propertySet&&(a.asset[e].content[f].propertySet=objectToArray(a.asset[e].content[f].propertySet.property))}d.create({assetRights:objectToArray(a.asset[e].assetRights),content:a.asset[e].content,id:a.asset[e].id,source:a.asset[e].source,propertySet:a.asset[e].propertySet?objectToArray(a.asset[e].propertySet.property):undefined,type:a.asset[e].type})}c.reset(),d.reset()}}typeof TapAPI=="undefined"&&(TapAPI={}),jQuery(function(){if(!navigator.geolocation)return;TapAPI.geoLocation={latest_location:null,interval:null,locate:function(){navigator.geolocation.getCurrentPosition(TapAPI.geoLocation.locationReceived,TapAPI.geoLocation.locationError)},locationReceived:function(a){TapAPI.geoLocation.latest_location=a,TapAPI.geoLocation.computeStopDistance(a),TapAPI.geoLocation.trigger("gotlocation",a)},locationError:function(a){console.log("locationError",a)},parseCurrentStopLocations:function(){_.each(tap.tourStops.models,function(a){if(a.get("location")===undefined){var b=a.getAssetsByUsage("geo");if(b){var c=b[0].get("content");if(c===undefined)return;var d=$.parseJSON(c.at(0).get("data"));d.type=="Point"&&a.set("location",new L.LatLng(d.coordinates[1],d.coordinates[0]))}}})},computeStopDistance:function(a){var b=new L.LatLng(a.coords.latitude,a.coords.longitude);_.each(tap.tourStops.models,function(a){var c=a.get("location");if(c!==undefined){var d=b.distanceTo(c);a.set("distance",d)}})},startLocating:function(a){a===undefined&&(a=5e3),TapAPI.geoLocation.locate(),TapAPI.geoLocation.interval=setInterval(TapAPI.geoLocation.locate,5e3)},stopLocating:function(){clearInterval(TapAPI.geoLocation.interval),TapAPI.geoLocation.interval=null}},_.extend(TapAPI.geoLocation,Backbone.Events)}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.templates=="undefined"&&(TapAPI.templates={}),TapAPI.templateManager={get:function(a){return TapAPI.templates[a]===undefined&&$.ajax({async:!1,dataType:"html",url:"js/backbone/templates/"+a+".tpl.html",success:function(b,c,d){TapAPI.templates[a]=_.template(b)}}),TapAPI.templates[a]}},typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.templates=="undefined"&&(TapAPI.templates={}),TapAPI.templates["audio-stop"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='tour-stop audio'>\n\t<div class='title'>"+tourStopTitle+'</div>\n\t<audio id="audio-player" autoplay controls="controls">\n\t\t<p>Your browser does not support the audio element.</p>\n\t</audio>\t\n\t<video id="video-player" autoplay controls="controls" style=\'display:none;\'>\n\t\t<p>Your browser does not support the video element.</p>\n\t</video>\n</div>';return __p},TapAPI.templates.dialog=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div data-role="dialog" id="'+id+'">\n\t<div data-role="header" data-theme="d">\n\t\t<h1></h1>\n\t</div>\n\t<div data-role="content" data-theme="c" align="center">\n\t\t'+content+"\n\t</div>\n</div>";return __p},TapAPI.templates["image-stop-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<li>\n\t<a href="'+fullImageUri+'"><img src="'+thumbUri+'" alt="'+title+'" title="'+title+'" /></a>\n</li>';return __p},TapAPI.templates["image-stop"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<ul id="gallery">\n</ul>';return __p},TapAPI.templates.keypad=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<fieldset class="ui-grid-b" id="keypad" data-theme=\'d\'>\n\t<div class="ui-block-a" id="writeStyle">\n\t\t<div class="ui-bar" id="write"></div>\n\t</div>\n\t<div class="ui-block-b">\n\t\t<div class="ui-bar ui-bar-d" id="gobtn">Go</div>\t\n\t</div>\n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">1</div></div>\n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">2</div></div>\t \n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">3</div></div>  \n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">4</div></div>\n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">5</div></div>\t \n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">6</div></div>  \n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">7</div></div>\n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">8</div></div>\t \n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">9</div></div>  \n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">0</div></div>\n\t<div class="ui-block-b" id="clearStyle">\n\t\t<div class="ui-bar ui-bar-d" id="delete">Clear</div>\n\t</div>\n</fieldset>\n';return __p},TapAPI.templates.page=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div data-role="header" data-position="fixed">\n\t<a id=\'back-button\' data-rel="back" data-mini="true">'+back_label+"</a>\n\t",header_nav?(__p+='\n\t<div id=\'index-selector\' data-role="controlgroup" data-type="horizontal" data-mini="true">\n\t\t',_.each(nav_menu,function(a){__p+='\n\t\t<a data-role="button" '+(active_index==a.prefix?'data-theme="b"':"")+" href='#"+a.prefix+"/"+tour_id+"'>"+a.label+"</a>\n\t\t"}),__p+="\n\t</div>\n\t"):__p+='\n\t<h1 id="page-title">'+title+"</h1>\n\t",__p+='\n</div>\n<div data-role="content">\n</div>\n<!--\n<div data-role="footer">\n</div>\n-->';return __p},TapAPI.templates["stop-group-list-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<a href="#tourstop/'+tourId+"/"+id+'">'+title+"</a>\n";return __p},TapAPI.templates["stop-group"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='tour-stop stop-group' style=\"width:100%;\">\n\t<div class='title'>"+tourStopTitle+"</div>\n\t<div class='description'>"+description+'</div>\n\t<ul id="stop-list" class="ui-listview" data-inset="true" data-role="listview"></ul>\n</div>\n';return __p},TapAPI.templates.stop=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='stop' style=\"width:100%;\">\n\t<div class='title'>"+tourStopTitle+"</div>\n\t<div class='description'>"+tourStopDescription+"</div>\n</div>\n";return __p},TapAPI.templates["tour-details"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="">\t\t\t\n\t<a href="#'+tour_index+"/"+tour_id+'" id="start-tour" data-role="button" data-theme="b">Start Tour</a>\n</div>\n<div class=\'tour-details\'>\n\t'+description+"\n</div>\n";return __p},TapAPI.templates["tour-list-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<a href="#tour/'+id+'">'+title+"</a>\n";return __p},TapAPI.templates["tour-list"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<ul id="tour-list" class="ui-listview" data-inset="true" data-role="listview"></ul>';return __p},TapAPI.templates["tour-map-marker-bubble"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='marker-bubble-content'>\n\t<div class='title'>"+title+"</div>\n\t<div class='distance'>"+distance+"</div>\n\t<div class='view-button'><a href='#tourstop/"+tour_id+"/"+stop_id+"'>View stop</a></div>\n\t<div class='directions'>Get Directions</div>\n</div>";return __p},TapAPI.templates["tour-map"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div id='tour-map'>Unable to display the map</div>";return __p},TapAPI.templates["tour-stop-list-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<a href='#tourstop/"+tour_id+"/"+stop_id+"'>"+title+"</a>";return __p},TapAPI.templates["tour-stop-list"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<ul id="tour-stop-list" class="ui-listview" data-inset="true" data-role="listview"></ul>';return __p},TapAPI.templates["video-stop"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='tour-stop video'>\n\t<div class='title'>"+tourStopTitle+'</div>\n\t<video id="video-player" poster="assets/images/tapPoster.png" controls="controls" autoplay="autoplay">\n\t\t<p>Your browser does not support the video tag.</p>\n\t</video>\n</div>\n';return __p};