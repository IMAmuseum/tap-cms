/*
 * TAP - v0.1.0 - 2012-07-17
 * http://tapintomuseums.org/
 * Copyright (c) 2011-2012 Indianapolis Museum of Art
 * GPLv3
 */
function getAttributeByLanguage(a){var b=[];for(var c=0;c<a.length;c++)(!a[c].lang||a[c].lang&&a[c].lang==tap.language)&&b.push(a[c]);return b.length===0&&(b=a),b}function loadXMLDoc(a){return xhttp=new XMLHttpRequest,xhttp.open("GET",a,!1),xhttp.send(),xhttp.responseXML}function objectToArray(a){if(a===undefined)return;return Object.prototype.toString.call(a)!=="[object Array]"?[a]:a}function xmlToJson(a,b){var c=!0,d=0;if(!b){b=["xml:"];for(d=0;d<a.documentElement.attributes.length;d++)a.documentElement.attributes.item(d).nodeName.indexOf("xmlns")!=-1&&b.push(a.documentElement.attributes.item(d).nodeName.replace("xmlns:","")+":")}var e=!0;if(a.attributes&&a.attributes.length>0){var f;e={};for(var g=0;g<a.attributes.length;g++)f=a.attributes.item(g),e[f.nodeName.replaceArray(b,"").toCamel()]=f.nodeValue}if(a.hasChildNodes()){var h,i,j;e===!0&&(e={});for(var k=0;k<a.childNodes.length;k++){j=a.childNodes.item(k);if((j.nodeType&7)===1)h=j.nodeName.replaceArray(b,"").toCamel(),i=xmlToJson(j,b),e.hasOwnProperty(h)?(e[h].constructor!==Array&&(e[h]=[e[h]]),e[h].push(i)):e[h]=i;else if((j.nodeType-1|1)===3){h="value",i=j.nodeType===3?j.nodeValue.replace(/^\s+|\s+$/g,""):j.nodeValue;if(e.hasOwnProperty(h))e[h]+=i;else if(j.nodeType===4||i!=="")e[h]=i}}}return e}String.prototype.replaceArray=function(a,b){var c=this;for(var d=0;d<a.length;d++)c=c.replace(a[d],b);return c},String.prototype.toCamel=function(){return this.replace(/\s(.)/g,function(a){return a.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(a){return a.toLowerCase()})},typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Asset=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"source":case"content":return getAttributeByLanguage(objectToArray(this.attributes[a]));default:return this.attributes[a]}},getPropertyByName:function(a){if(_.isUndefined(this.get("propertySet")))return!1;var b=_.find(this.get("propertySet"),function(a){return a.name===key});return _.isUndefined(b)?!1:b.value}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Stop=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}},getPropertyByName:function(a){if(_.isUndefined(this.get("propertySet")))return!1;var b=_.find(this.get("propertySet"),function(b){return b.name===a});return _.isUndefined(b)?!1:b.value},getAssets:function(){if(_.isUndefined(this.get("assetRef")))return!1;var a=[];return _.each(this.get("assetRef"),function(b){a.push(tap.tourAssets.get(b.id))}),_.isEmpty(a)?!1:a},getAssetsByUsage:function(a){if(_.isUndefined(this.get("assetRef")))return!1;var b=[];return _.each(this.get("assetRef"),function(c){c.usage===a&&b.push(tap.tourAssets.get(c.id))}),_.isEmpty(b)?!1:b},getSortedConnections:function(){return _.isUndefined(this.get("connections"))?!1:_.sortBy(this.get("connection"),function(a){return parseInt(a.priority,10)})}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.models=="undefined"&&(TapAPI.models={}),TapAPI.models.Tour=Backbone.Model.extend({get:function(a){if(!this.attributes[a])return this.attributes[a];switch(a){case"tourMetadata":case"propertySet":case"description":case"title":return getAttributeByLanguage(this.attributes[a]);default:return this.attributes[a]}}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Assets=Backbone.Collection.extend({model:TapAPI.models.Asset,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-asset")}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Stops=Backbone.Collection.extend({model:TapAPI.models.Stop,initialize:function(a,b){this.localStorage=new Backbone.LocalStorage(b+"-stop")},getStopByKeycode:function(a){for(var b=0;b<this.models.length;b++)if(this.models[b].get("propertySet"))for(var c=0;c<this.models[b].get("propertySet").length;c++)if(this.models[b].get("propertySet")[c].name=="code"&&this.models[b].get("propertySet")[c].value==a)return this.models[b];return!1}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.collections=="undefined"&&(TapAPI.collections={}),TapAPI.collections.Tours=Backbone.Collection.extend({model:TapAPI.models.Tour,localStorage:new Backbone.LocalStorage("tours"),selectTour:function(a){tap.currentTour=a,tap.tours.get(a).get("rootStopRef")&&(tap.currentStop=tap.tours.get(a).get("rootStopRef").id),tap.tourStops=new TapAPI.collections.Stops(null,a),tap.tourAssets=new TapAPI.collections.Assets(null,a),tap.GeoLocation!==null&&tap.tourStops.on("reset",TapAPI.geoLocation.stopsReset),tap.tourAssets.fetch(),tap.tourStops.fetch()}}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Page=Backbone.View.extend({initialize:function(a){_.defaults(this.options,{page_title:"",back_label:"Back",nav_menu:[{label:"Menu",prefix:"tourstoplist"},{label:"Keypad",prefix:"tourkeypad"},{label:"Map",prefix:"tourmap"}],active_index:null,header_nav:!0}),this.onInit&&this.onInit()},close:function(){this.$el.empty().undelegate(),this.unbind(),this.undelegateEvents(),this.onClose&&this.onClose()},render:function(a){return this.$el.empty(),this.$el.html(TapAPI.templateManager.get("page")({title:this.options.page_title,back_label:this.options.back_label,header_nav:this.options.header_nav,nav_menu:this.options.nav_menu,active_index:this.options.active_index,tour_id:tap.currentTour})),this.renderContent(),this},renderContent:function(){console.log("Warning: abstract TapApi.views.Page::renderContent")}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_audio_stop="AudioStop",TapAPI.views.registry.AudioStop="AudioStop",jQuery(function(){TapAPI.views.AudioStop=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("audio-stop");$(":jqmData(role='content')",this.$el).append(a({tourStopTitle:this.model.get("title")[0].value}));var b=tap.currentStop.get("assetRef");return b&&(_.each(b,function(a){var b=tap.tourAssets.get(a.id),c=b.get("source");_.each(c,function(a){var b="<source src='"+a.uri+"' type='"+a.format+"' />";switch(a.format.substring(0,5)){case"audio":$("#audio-player",this.$el).append(b);break;case"video":$("#video-player",this.$el).append(b);break;default:console.log("Unsupported format for audio asset:",a)}},this)},this),$("#video-player source",this.$el).length&&!$("#audio-player source",this.$el).length&&($("#audio-player",this.$el).hide(),$("#video-player",this.$el).show())),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Stop=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("stop");return $(":jqmData(role='content')",this.$el).append(a({tourStopTitle:this.model.get("title")?this.model.get("title")[0].value:undefined,tourStopDescription:this.model.get("description")?this.model.get("description")[0].value:undefined})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Dialog=Backbone.View.extend({template:TapAPI.templateManager.get("dialog"),content:"",render:function(a){return this.$el.empty(),$(this.el).html(this.template({content:this.content})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_image_stop="ImageStop",TapAPI.views.registry.ImageStop="ImageStop",jQuery(function(){TapAPI.views.ImageStop=TapAPI.views.Page.extend({renderContent:function(){var a,b,c=tap.currentStop.get("assetRef"),d=TapAPI.templateManager.get("image-stop");c&&$.each(c,function(){$assetItem=tap.tourAssets.models;for(var c=0;c<$assetItem.length;c++)$assetItem[c].get("id")==this.id&&(this.usage=="primary"||this.usage=="tour_image")&&(a=$assetItem[c].get("source")[0].uri),$assetItem[c].get("id")==this.id&&this.usage=="icon"&&(b=$assetItem[c].get("source")[0].uri)}),$(":jqmData(role='content')",this.$el).append(d({tourImageUri:a,tourIconUri:b,tourStopTitle:tap.currentStop.get("title")[0].value}));var e=$("#soloImage a",this.$el).photoSwipe({enableMouseWheel:!1,enableKeyboard:!0,doubleTapZoomLevel:0,captionAndToolbarOpacity:.8,minUserZoom:0,preventSlideshow:!0,jQueryMobile:!0});return this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Keypad=TapAPI.views.Page.extend({events:{"tap #gobtn":"submit","tap #keypad div .button":"writekeycode","tap #delete":"clearkeycode"},onInit:function(){this.options.active_index="tourkeypad"},renderContent:function(){var a=TapAPI.templateManager.get("keypad");$(":jqmData(role='content')",this.$el).append(a())},submit:function(){if(!$("#write").html())return;if(!tap.tourStops.getStopByKeycode($("#write").html())){tap.router.showDialog("error","This is an invalid code. Please enter another."),$("#write").html("");return}$destUrl="#tourstop/"+tap.currentTour+"/code/"+$("#write").html(),Backbone.history.navigate($destUrl,!0)},writekeycode:function(a){$("#write").html($("#write").html()+$(a.currentTarget).html())},clearkeycode:function(a){$("#write").html("")},close:function(){}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.Map=TapAPI.views.Page.extend({onInit:function(){console.log("MapView.initialize"),this.options.active_index="tourmap",this.tile_layer=new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',maxZoom:18}),this.map=null,this.stop_markers={},this.stop_popups={},this.position_marker=null,this.view_initialized=!1,this.LocationIcon=L.Icon.extend({iconUrl:"assets/images/icon-locate.png",shadowUrl:null,iconSize:new L.Point(24,24),iconAnchor:new L.Point(12,12)}),this.MarkerIcon=L.Icon.extend({iconUrl:"assets/images/marker.png",shadowUrl:"assets/images/marker-shadow.png",iconSize:new L.Point(25,41),iconAnchor:new L.Point(12,41)}),this.marker_icon=new this.MarkerIcon,_.defaults(this.options,{"init-lat":39.829104,"init-lon":-86.189504,"init-zoom":2,units:"si"})},renderContent:function(){var a=TapAPI.templateManager.get("tour-map");$(":jqmData(role='content')",this.$el).addClass("map-content").append(a()),$(":jqmData(role='page')").live("pageshow",{map_view:this},function(a){a.data.map_view.resizeContentArea(),a.data.map_view.map===null&&a.data.map_view.initMap()}),$(window).bind("orientationchange resize",this.resizeContentArea)},initMap:function(){this.map=new L.Map("tour-map"),this.map.addLayer(this.tile_layer),TapAPI.geoLocation!==null&&TapAPI.geoLocation.latest_location!==null&&(this.options["init-lat"]=TapAPI.geoLocation.latest_location.coords.latitude,this.options["init-lon"]=TapAPI.geoLocation.latest_location.coords.longitude,this.position_marker===null&&(this.position_marker=new L.Marker(new L.LatLng(this.options["init-lat"],this.options["init-lon"]),{icon:new this.LocationIcon}),this.map.addLayer(this.position_marker))),this.map.setView(new L.LatLng(this.options["init-lat"],this.options["init-lon"]),this.options["init-zoom"]);for(var a=0;a<this.options.stops.size();a++)var b=this.options.stops.at(a),c=b.get("assetRef"),d=_.each(c,this.plotTourStopMarker,{stop:b,map_view:this});return TapAPI.geoLocation.on("gotlocation",this.onLocationFound,this),this},plotTourStopMarker:function(a){if(a===undefined||a.usage!="geo")return;asset=tap.tourAssets.get(a.id);var b=$.parseJSON(asset.get("content")[0].data.value);if(b.type=="Point"){var c=new L.LatLng(b.coordinates[1],b.coordinates[0]),d=new L.Marker(c,{icon:this.map_view.marker_icon}),e=TapAPI.templateManager.get("tour-map-marker-bubble"),f=new L.Popup;f.setLatLng(c);var g="";this.stop.get("distance")&&(g="Distance: "+this.map_view.formatStopDistance(this.stop.get("distance"))),f.setContent(e({title:this.stop.get("title")[0].value,tour_id:tap.currentTour,stop_id:this.stop.id,distance:g})),this.map_view.stop_popups[this.stop.id]=f,d.stop_id=this.stop.id,d.addEventListener("click",this.map_view.onMarkerSelected,this.map_view),this.map_view.stop_markers[this.stop.id]=d,this.map_view.map.addLayer(d)}this.stop.on("change:distance",function(a){var b="";a.get("distance")&&(b="Distance: "+this.formatStopDistance(a.get("distance"))),this.stop_popups[a.id].setContent(e({title:a.get("title")[0].value,tour_id:tap.currentTour,stop_id:a.get("id"),distance:b}))},this.map_view)},onMarkerSelected:function(a){this.map.openPopup(this.stop_popups[a.target.stop_id])},onLocationFound:function(a){var b=new L.LatLng(a.coords.latitude,a.coords.longitude);this.position_marker===null?(this.position_marker=new L.Marker(b,{icon:new this.LocationIcon}),this.map.addLayer(this.position_marker)):this.position_marker.setLatLng(b)},onLocationError:function(a){console.log("onLocationError",a)},formatStopDistance:function(a){if(this.options.units=="si")return a<1e3?a.toFixed(2)+" m":(a/1e3).toFixed(2)+" km"},resizeContentArea:function(){var a,b,c,d,e;window.scroll(0,0);var f=$(":jqmData(role='page')");d=f.find(":jqmData(role='header'):visible"),c=f.find(":jqmData(role='footer'):visible"),a=f.find(":jqmData(role='content'):visible"),e=$(window).height(),b=e-d.outerHeight()-c.outerHeight(),f.find(":jqmData(role='content')").first().height(b)},onClose:function(){$(window).unbind("orientationchange resize",this.resizeContentArea)}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_stop_group="StopGroup",TapAPI.views.registry.StopGroup="StopGroup",jQuery(function(){TapAPI.views.StopGroup=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("stop-group"),b={tourStopTitle:this.model.get("title")[0].value},c=this.model.get("description");c!==undefined?b.description=c[0].value:b.description="",$(":jqmData(role='content')",this.$el).append(a(b));var d=this.model.get("connection"),e=this.$el.find("#stop-list");_.each(d,function(a){var b=tap.tourStops.get(a.destId);if(b){var c=new TapAPI.views.StopGroupListItem({model:b});e.append(c.render().$el)}})}}),TapAPI.views.StopGroupListItem=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("stop-group-list-item"),render:function(){return this.$el.html(this.template({title:this.model.get("title")?this.model.get("title")[0].value:undefined,id:this.model.get("id"),tourId:tap.currentTour})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.StopList=TapAPI.views.Page.extend({onInit:function(){this.options.active_index="tourstoplist"},renderContent:function(){var a=TapAPI.templateManager.get("tour-stop-list");$(":jqmData(role='content')",this.$el).append(a()),_.each(tap.tourStops.models,function(a){if(tap.config.StopListView.codes_only){var b=undefined;_.each(a.get("propertySet"),function(a){a.name=="code"&&(b=a.value)});if(b===undefined)return}var c=new TapAPI.views.StopListItem({model:a});$("#tour-stop-list",this.$el).append(c.render().el)},this)}}),TapAPI.views.StopListItem=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("tour-stop-list-item"),render:function(){return $(this.el).html(this.template({title:this.model.get("title")?this.model.get("title")[0].value:undefined,stop_id:this.model.get("id"),tour_id:tap.currentTour})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.TourDetails=TapAPI.views.Page.extend({onInit:function(){this.options.page_title=this.model.get("title")[0].value,this.options.header_nav=!1},renderContent:function(){var a=TapAPI.templateManager.get("tour-details");$(":jqmData(role='content')",this.$el).append(a({tour_index:tap.config.default_index,tour_id:this.model.id,publishDate:this.model.get("publishDate")?this.model.get("publishDate")[0].value:undefined,description:this.model.get("description")?this.model.get("description")[0].value:undefined,stopCount:tap.tourStops.length,assetCount:tap.tourAssets.length}))}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),jQuery(function(){TapAPI.views.TourList=TapAPI.views.Page.extend({onInit:function(){this.options.page_title="Tour List",this.options.header_nav=!1},renderContent:function(){var a=TapAPI.templateManager.get("tour-list");$(":jqmData(role='content')",this.$el).append(a),_.each(this.model.models,function(a){$("#tour-list",this.$el).append((new TapAPI.views.TourListItem({model:a})).render().el)},this),$("#tour-list").listview("refresh")}}),TapAPI.views.TourListItem=Backbone.View.extend({tagName:"li",template:TapAPI.templateManager.get("tour-list-item"),render:function(){return $(this.el).html(this.template({title:this.model.get("title")?this.model.get("title")[0].value:undefined,id:this.model.get("id")})),this}})}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.views=="undefined"&&(TapAPI.views={}),typeof TapAPI.views.registry=="undefined"&&(TapAPI.views.registry={}),TapAPI.views.registry.tour_video_stop="VideoStop",TapAPI.views.registry.VideoStop="VideoStop",jQuery(function(){TapAPI.views.VideoStop=TapAPI.views.Page.extend({renderContent:function(){var a=TapAPI.templateManager.get("video-stop");$(":jqmData(role='content')",this.$el).append(a({tourStopTitle:this.model.get("title")[0].value}));var b=tap.currentStop.get("assetRef");return b&&_.each(b,function(a){var b=tap.tourAssets.get(a.id),c=b.get("source");_.each(c,function(a){$("video",this.$el).append("<source src='"+a.uri+"' type='"+a.format+"' />")},this)},this),this}})}),jQuery(function(){AppRouter=Backbone.Router.extend({views:{},routes:{"":"list","tour/:tour_id":"tourDetails","tourkeypad/:tour_id":"tourKeypad","tourstop/:tour_id/:stop_id":"tourStopById","tourstop/:tour_id/code/:stop_code":"tourStopByCode","tourmap/:tour_id":"tourMap","tourstoplist/:tour_id":"tourStopList"},bookmarkMode:!1,initialize:function(){$("#back-button").live("click",function(a){return a.preventDefault(),window.history.back(),!1}),this.firstPage=!0},list:function(){this.changePage(new TapAPI.views.TourList({model:tap.tours}))},tourDetails:function(a){tap.tours.selectTour(a),this.changePage(new TapAPI.views.TourDetails({model:tap.tours.get(tap.currentTour)}))},tourKeypad:function(a){tap.tours.selectTour(a),this.changePage(new TapAPI.views.Keypad({model:tap.tours.get(tap.currentTour),page_title:"Enter a code"}))},tourStop:function(){var a=TapAPI.views.registry[tap.currentStop.get("view")];a===undefined&&(console.log("View not in registry: ",tap.currentStop.get("view")),a="Stop"),this.changePage(new TapAPI.views[a]({model:tap.currentStop,page_title:tap.tours.get(tap.currentTour).get("title")[0].value}))},tourStopById:function(a,b){tap.tours.selectTour(a),tap.currentStop=tap.tourStops.get(b),this.tourStop()},tourStopByCode:function(a,b){tap.tours.selectTour(a),tap.currentStop=tap.tourStops.getStopByKeycode(b),this.tourStop()},tourStopList:function(a){tap.tours.selectTour(a),this.changePage(new TapAPI.views.StopList({model:tap.tours.get(tap.currentTour)}))},tourMap:function(a){tap.tours.selectTour(a);var b={stops:tap.tourStops},c=tap.tours.get(tap.currentTour);_.each(c.get("appResource"),function(a){if(a===undefined||a.usage!="geo")return;asset=tap.tourAssets.get(a.id);var c=$.parseJSON(asset.get("content")[0].data.value);c.type=="Point"&&(b["init-lon"]=c.coordinates[0],b["init-lat"]=c.coordinates[1])}),_.each(c.get("propertySet"),function(a){a.name=="initial_map_zoom"&&(b["init-zoom"]=a.value)}),this.changePage(new TapAPI.views.Map(b))},changePage:function(a){tap.currentView!==undefined&&tap.currentView.close(),tap.currentView=a,$(a.el).attr("data-role","page"),a.render(),$("body").append($(a.el));var b=$.mobile.defaultPageTransition;this.firstPage&&(b="none",this.firstPage=!1),$.mobile.changePage($(a.el),{changeHash:!1,transition:b})},showDialog:function(a,b){var c=TapAPI.templateManager.get("dialog")({id:a,content:b});$("body").append(c),$.mobile.changePage("#"+a,{changeHash:!1,transition:"pop"})}})});if(!tap){var tap={};tap.tours={},tap.tourAssets={},tap.tourStops={},tap.language="en",tap.currentStop="",tap.currentTour="",_.extend(tap,Backbone.Events),tap.initApp=function(a,b){tap.url=a,b===undefined&&(b={}),tap.config=_.defaults(b,{default_index:"tourstoplist",StopListView:{codes_only:!0}}),tap.trigger("tap.init.start"),tap.tours=new TapAPI.collections.Tours,tap.tours.fetch();if(!tap.tours.length){var c=xmlToJson(loadXMLDoc(tap.url)),d,e;if(c.tour)tap.initModels(c.tour);else if(c.tourSet&&c.tourSet.tourRef){e=c.tourSet.tourRef.length;for(d=0;d<e;d++){var f=xmlToJson(loadXMLDoc(c.tourSet.tourRef[d].uri));tap.initModels(f.tour)}}else if(c.tourSet&&c.tourSet.tour){e=c.tourSet.tour.length;for(d=0;d<e;d++)tap.initModels(c.tourSet.tour[d])}}tap.trigger("tap.init.end"),tap.router=new AppRouter},tap.initModels=function(a){tap.tours.create({id:a.id,appResource:a.tourMetadata&&a.tourMetadata.appResource?objectToArray(a.tourMetadata.appResource):undefined,connection:objectToArray(a.connection),description:a.tourMetadata&&a.tourMetadata.description?objectToArray(a.tourMetadata.description):undefined,lastModified:a.tourMetadata&&a.tourMetadata.lastModified?a.tourMetadata.lastModified:undefined,propertySet:a.tourMetadata&&a.tourMetadata.propertySet?objectToArray(a.tourMetadata.propertySet.property):undefined,publishDate:a.tourMetadata&&a.tourMetadata.publishDate?objectToArray(a.tourMetadata.publishDate):undefined,rootStopRef:a.tourMetadata&&a.tourMetadata.rootStopRef?a.tourMetadata.rootStopRef:undefined,title:a.tourMetadata&&a.tourMetadata.title?objectToArray(a.tourMetadata.title):undefined});var b,c,d=new TapAPI.collections.Stops(null,a.id),e=a.stop.length;for(b=0;b<e;b++){var f=[];if(!_.isUndefined(a.connection))for(c=0;c<a.connection.length;c++)a.connection[c].srcId==a.stop[b].id&&f.push({priority:a.connection[c].priority,destId:a.connection[c].destId});d.create({id:a.stop[b].id,connection:f,view:a.stop[b].view,description:objectToArray(a.stop[b].description),propertySet:a.stop[b].propertySet?objectToArray(a.stop[b].propertySet.property):undefined,assetRef:objectToArray(a.stop[b].assetRef),title:objectToArray(a.stop[b].title)})}var g=new TapAPI.collections.Assets(null,a.id),h=a.asset.length;for(b=0;b<h;b++){if(a.asset[b].source&&a.asset[b].source){var i=[],j=a.asset[b].source.length;for(c=0;c<j;c++)a.asset[b].source[c].propertySet&&(a.asset[b].source[c].propertySet=a.asset[b].source[c].propertySet.property)}g.create({assetRights:objectToArray(a.asset[b].assetRights),content:objectToArray(a.asset[b].content),id:a.asset[b].id,source:objectToArray(a.asset[b].source),propertySet:a.asset[b].propertySet?objectToArray(a.asset[b].propertySet.property):undefined})}d.reset(),g.reset()}}typeof TapAPI=="undefined"&&(TapAPI={}),jQuery(function(){if(!navigator.geolocation)return;TapAPI.geoLocation={latest_location:null,locate:function(){navigator.geolocation.getCurrentPosition(TapAPI.geoLocation.locationReceived,TapAPI.geoLocation.locationError)},locationReceived:function(a){TapAPI.geoLocation.latest_location=a,TapAPI.geoLocation.computeStopDistance(a),TapAPI.geoLocation.trigger("gotlocation",a)},locationError:function(a){console.log("locationError",a)},stopsReset:function(){_.each(tap.tourStops.models,function(a){if(a.get("location")===undefined){var b=a.getAssetsByUsage("geo");if(b){var c=$.parseJSON(b[0].get("content")[0].data.value);c.type=="Point"&&a.set("location",new L.LatLng(c.coordinates[1],c.coordinates[0]))}}})},computeStopDistance:function(a){var b=new L.LatLng(a.coords.latitude,a.coords.longitude);_.each(tap.tourStops.models,function(a){var c=a.get("location");if(c!==undefined){var d=b.distanceTo(c);a.set("distance",d)}})}},_.extend(TapAPI.geoLocation,Backbone.Events),TapAPI.geoLocation.locate(),setInterval(TapAPI.geoLocation.locate,5e3)}),typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.templates=="undefined"&&(TapAPI.templates={}),TapAPI.templateManager={get:function(a){return TapAPI.templates[a]===undefined&&$.ajax({async:!1,dataType:"html",url:"js/backbone/templates/"+a+".tpl.html",success:function(b,c,d){TapAPI.templates[a]=_.template(b)}}),TapAPI.templates[a]}},typeof TapAPI=="undefined"&&(TapAPI={}),typeof TapAPI.templates=="undefined"&&(TapAPI.templates={}),TapAPI.templates["audio-stop"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='tour-stop audio'>\n\t<div class='title'>"+tourStopTitle+'</div>\n\t<audio id="audio-player" autoplay controls="controls">\n\t\t<p>Your browser does not support the audio element.</p>\n\t</audio>\t\n\t<video id="video-player" autoplay controls="controls" style=\'display:none;\'>\n\t\t<p>Your browser does not support the video element.</p>\n\t</video>\n</div>';return __p},TapAPI.templates.dialog=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div data-role="dialog" id="'+id+'">\n\t<div data-role="header" data-theme="d">\n\t\t<h1></h1>\n\t</div>\n\t<div data-role="content" data-theme="c" align="center">\n\t\t'+content+"\n\t</div>\n</div>";return __p},TapAPI.templates["image-stop"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div id="soloImage">\n\t<a href="'+tourImageUri+'"><img src="'+tourImageUri+'" alt="Image 01" class="primaryImg" /></a>\n\t<div class=\'title\'>'+tourStopTitle+"</div>\n</div>";return __p},TapAPI.templates.keypad=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<fieldset class="ui-grid-b" id="keypad" data-theme=\'d\'>\n\t<div class="ui-block-a" id="writeStyle">\n\t\t<div class="ui-bar" id="write"></div>\n\t</div>\n\t<div class="ui-block-b">\n\t\t<div class="ui-bar ui-bar-d" id="gobtn">Go</div>\t\n\t</div>\n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">1</div></div>\n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">2</div></div>\t \n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">3</div></div>  \n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">4</div></div>\n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">5</div></div>\t \n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">6</div></div>  \n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">7</div></div>\n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">8</div></div>\t \n\t<div class="ui-block-b"><div class="button ui-bar ui-bar-d">9</div></div>  \n\t<div class="ui-block-a"><div class="button ui-bar ui-bar-d">0</div></div>\n\t<div class="ui-block-b" id="clearStyle">\n\t\t<div class="ui-bar ui-bar-d" id="delete">Clear</div>\n\t</div>\n</fieldset>\n';return __p},TapAPI.templates.page=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div data-role="header">\n\t<a id=\'back-button\' data-rel="back">'+back_label+"</a>\n\t",header_nav?(__p+='\n\t<div id=\'index-selector\' class=\'ui-title\' data-role="controlgroup" data-type="horizontal" data-mini="true">\n\t\t',_.each(nav_menu,function(a){__p+='\n\t\t<a data-role="button" '+(active_index==a.prefix?'data-theme="b"':"")+" href='#"+a.prefix+"/"+tour_id+"'>"+a.label+"</a>\n\t\t"}),__p+="\n\t</div>\n\t"):__p+='\n\t<h1 id="page-title">'+title+"</h1>\n\t",__p+='\n</div>\n<div data-role="content">\n</div>\n<!--\n<div data-role="footer">\n</div>\n-->';return __p},TapAPI.templates["stop-group-list-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<a href="#tourstop/'+tourId+"/"+id+'">'+title+"</a>\n";return __p},TapAPI.templates["stop-group"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='tour-stop stop-group' style=\"width:100%;\">\n\t<div class='title'>"+tourStopTitle+"</div>\n\t<div class='description'>"+description+'</div>\n\t<ul id="stop-list" class="ui-listview" data-inset="true" data-role="listview"></ul>\n</div>\n';return __p},TapAPI.templates.stop=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='stop' style=\"width:100%;\">\n\t<div class='title'>"+tourStopTitle+"</div>\n\t<div class='description'>"+tourStopDescription+"</div>\n</div>\n";return __p},TapAPI.templates["tour-details"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<div class="">\t\t\t\n\t<a href="#'+tour_index+"/"+tour_id+'" id="start-tour" data-role="button" data-theme="b">Start Tour</a>\n</div>\n<div class=\'tour-details\'>\n\t'+description+"\n</div>\n";return __p},TapAPI.templates["tour-list-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<a href="#tour/'+id+'">'+title+"</a>\n";return __p},TapAPI.templates["tour-list"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<ul id="tour-list" class="ui-listview" data-inset="true" data-role="listview"></ul>';return __p},TapAPI.templates["tour-map-marker-bubble"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='marker-bubble-content'>\n\t<div class='title'>"+title+"</div>\n\t<div class='distance'>"+distance+"</div>\n\t<div class='view-button'><a href='#tourstop/"+tour_id+"/"+stop_id+"'>View stop</a></div>\n\t<div class='directions'>Get Directions</div>\n</div>";return __p},TapAPI.templates["tour-map"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div id='tour-map'>Unable to display the map</div>";return __p},TapAPI.templates["tour-stop-list-item"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<a href='#tourstop/"+tour_id+"/"+stop_id+"'>"+title+"</a>";return __p},TapAPI.templates["tour-stop-list"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+='<ul id="tour-stop-list" class="ui-listview" data-inset="true" data-role="listview"></ul>';return __p},TapAPI.templates["video-stop"]=function(obj){var __p="",print=function(){__p+=Array.prototype.join.call(arguments,"")};with(obj||{})__p+="<div class='tour-stop video'>\n\t<div class='title'>"+tourStopTitle+'</div>\n\t<video id="video-player" poster="assets/images/tapPoster.png" controls="controls" autoplay="autoplay">\n\t\t<p>Your browser does not support the video tag.</p>\n\t</video>\n</div>\n';return __p};